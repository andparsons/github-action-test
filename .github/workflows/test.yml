name: Test

on:
  push:
    branches: [ main ]


jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
      - uses: actions/checkout@v2
        with:
          clean: false
      - name: Add key
        id: add_key
        shell: bash
        env:
          PUBLIC_KEY: ${{ secrets.PUBLIC_KEY }}
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
        run: |
          mkdir ~/.ssh
          eval "$(ssh-agent -s)"
          echo "$PRIVATE_KEY" >> ~/.ssh/id_ed25519
          echo "$PUBLIC_KEY" >> ~/.ssh/id_ed25519.pub
          chmod 600 ~/.ssh/id_*
          ssh-add ~/.ssh/id_ed25519
          ssh-add -L

      - name: Test keys
        id: test_keys
        shell: bash
        run: |
          eval "$(ssh-agent -s)"
          ssh-add -L

      - name: Push
        id: push
        shell: bash
        env:
          REPO: ${{ secrets.REPO }}
        run: |
          eval "$(ssh-agent -s)"
          git remote add LIVE "$REPO"
          git push LIVE main
